backup_libheader () 
{ 
    : " This is the backuplib Function Library Comment Header";
    : "Copyright 2025, Marty McGowwan @ Shell Functions";
    : date: 2025-05-08;
    :;
    : " This program is free software: you can redistribute it and/or modify";
    : "it under the terms of the GNU General Public License as published by";
    : "the Free Software Foundation, either version 3 of the License, or";
    : "(at your option) any later version.";
    :;
    : " This program is distributed in the hope that it will be useful,";
    : "but WITHOUT ANY WARRANTY; without even the implied warranty of";
    : "MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the";
    : "GNU General Public License for more details.";
    :;
    : " You should have received a copy of the GNU General Public License";
    : "along with this program.  If not, see <https://www.gnu.org/licenses/>.";
    :;
    : date: 2025-05-08 - even libheaders need a date;
    :
}
backup () 
{ 
    : ~ one or more files down the $BACKUP_DIRECTORY/.bak/.bak/... stack;
    : date: 2023-09-20;
    : date: 2026-01-22: backup_init done at library install;
    foreach_ backup_one "$@"
}
backup_files () 
{ 
    : only immediate backupups;
    : related: version_files w.r.t .bak;
    : lib: zshutilib
    : date: 2023-10-21;
    indir ${BACKUP_DIRECTORY:-.bak} namedfiles
}
backup_here () {
    : recursively move backups down the stack
    : clearing the way for their replacement at the top
    : uses: chmod, cmp, mkdir
    : lib: zshutilib
    debug ENTRY $@
    [ -n "$ZSH_VERSION" ] && echo "depth: ${#funcstack}"
    set $1 ${BACKUP_DIRECTORY} "${2:-$PWD}"
    debug SET $@ $(dirs)
    [[ -d $2 ]] || mkdir $2
    if [[ "$3" == "$PWD" ]]; then
	: debug TEST: "$3" equal $PWD
	if cmp -s "$1" "$2/$1" 2>/dev/null; then
	    echo "$1 unchanged, skipping backup"
	    return 0
	fi
    fi
    local mode=$(classic_mode "$1") 
    [[ -f "$2/$1" ]] && {
	: debug DOWN "$@" $(dirs)
	cd "$2"
	echo "DIRS: " $(dirs)
	backup_here "$1" "$3"
    } || {
	mv $1 $2/$1
	[[ $3 == $PWD ]] && {
	    : debug DONE: "$@" $(dirs)
	    cp $2/$1 $1
	    timestamp $2/$1 $1
	    chmod $mode $1
	    cd ..
	    : debug STACK RETURN $(dirs)
	    return
	}
	cd ..
	echo "DIRS: " $(dirs)
	backup_here $1 "$3"
    }
}
backup_init () 
{
    : establish {BACKUP,VERSION}_DIRECTORY ENV vars;
    : date: 2023-09-18;
    : date: 2026-01-20: specify working dir or use cwd
    : lib: zshutilib
    debug $# $@
    if [[ $# -gt 1 ]]; then
	usage "[backupworkingdir] - provide alternate working directory for backup, or use cwd"
	return
    fi
    setenv BACKUP_DIRECTORY ${1:-.}/.bak > /dev/null;
    setenv VERSION_DIRECTORY ${1:-.}/.ver > /dev/null
}
backup_one () 
{
    # 2026-01-01: TODO: revisit the non-local directory operation
    : for a single file in possible non-local directory;
    : uses: basename, dirname;
    : lib: zshutilib;
    : date: 2023-09-11;
    : debug ENTRY $PWD $@;
    : date: 2026-01-15;
    local file=${1:-/dev/null};
    report_notfile $file && return 1
    local file=$(basename $file);
    local dir=$(dirname $1);
    quiet pushd $dir;
    : debug PUSHD $(dirs);
    : pause;
    backup_here $file;
    quiet popd;
    : debug POPD $(dirs);
    : pause
}
backup_onlyfiles () 
{ 
    : candidate backup files, including DOT files;
    : lib: zshutilib
    : date: 2026-01-01: use array to handle shell expansion
    local files=( * .* )
    foreach_ name_existing "${files[@]}"
}
backup_outdated () 
{ 
    : files in .bak/ tree not in cwd;
    : uses: comm
    comm -13 <(backup_onlyfiles) <(indir ${BACKUP_DIRECTORY:-.bak} backup_onlyfiles)
}
backup_prunefiles () {
    : prune bak files not linked to a version
    : uses: basename, find, rm, sort, xargs
    : debug echo $(pwd)
    for f in $(find ${VERSION_DIRECTORY:-.ver} -type f)
    do
	: debug echo $f
	find ${BACKUP_DIRECTORY:-.}/.bak/.bak -name $(basename $f) -links 1
    done | sort -u | xargs rm -v
    : prune unversioned files older than the last 2 backups
    find ${BACKUP_DIRECTORY:-.}/.bak/.bak/.bak -type f -links 1 | xargs rm -v
}
backup_needed () {
    : files in cwd not in $BACKUP_DIRECTORY tree
    : uses: cmp
    cmp -s "$1" ${BACKUP_DIRECTORY:-.bak}/"$1" || echo "$1"
}
backup_status () {
	: show backup and version info of shell lib files in $BACKUP_DIRECTORY
	: uses: tree
	: lib: zshutilib
	: date: 2026-01-21
	: debug ENTRY "$*"
	echo "libraries in cwd that are not backed up in $(dirname $BACKUP_DIRECTORY):"
	foreach_ backup_needed *lib
	if confirm "Show all version and backup files"; then
	    echo "\nversion files:"
	    version_files
	    tree -a ${VERSION_DIRECTORY:-.ver}
	    echo "\nsbackup tree:"
	    tree -a ${BACKUP_DIRECTORY:-.bak}
	fi
}

