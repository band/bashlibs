# 2025-12-16: preliminary version library
# - based on SimpleVersion.md
# ``` example
# ln -f  a/b/.bak/file  .ver/{YYYY_MMDD_hhmmss}/a/b/file
# ```
#
# 2025-12-27: TODO: revisit dependency on 'backup_init' and ENV vars
version_init ()
{
    : date: 2025-12-16;
    if [ ! -d $VERSION_DIRECTORY ]; then
        mkdir $VERSION_DIRECTORY
    fi
}
# 2025-12-27: TODO: this entire function-based workflow needs review
# - specifically the filename independent notion of versions
# - my model is now different from the way these functions work
version_one ()
{
    : for a single file in current directory;
    : date: 2025-12-16;
    : debug ENTRY $PWD $@;
    local file=${1:-/dev/null};
    if [ ! -f "$file" ]; then
        debug NOT file: $file;
	: pause;
	return 1
    fi
    debug FILE $file;
    : pause;
    local verdir=$VERSION_DIRECTORY/$(next_version)
    mkdir $verdir
    ln -f ./.bak/$file $verdir/$file
}
# 2025-12-16: copied from .prior-work-files/lib/fun/utillib
my_versions () 
{ 
    : list local directory version numbers from the most recent;
    : versions must begin with 1 or more digits;
    : related: backup_ver to set the x.y.z nums;
    : date: 2023-09-26;
    : date: 2023-09-30;
    : date: 2023-12-15;
    : date: 2024-01-06;
    : date: 2024-06-19;
    : date: 2024-07-13;
    local dir=$(basename $PWD);
    debug dir: $dir;
    [[ $dir = ".ver" ]] && { 
        indir .. $(myname);
        return
    };
    indir .ver ls -at1 | grep '^[0-9][0-9]*[.]'
}
latest_version () 
{ 
    : most recent in numero-alphic order;
    : date: 2023-09-26;
    : date: 2023-09-30;
    : date: 2024-06-19;
    my_versions | sed 1q
}

# 2025-12-16: copied from .prior-work-files/lib/fun/maintlib
mmp_version () 
{ 
    : space delimited Main, Minor, point version;
    : date: 2024-05-28;
    : date: 2024-06-19;
    my_versions | awk -F. '{ printf "%5d\t%5d\t%5d\n", $1, $2, $3 }' | sort -r | sed 1q
}
# 2025-12-27: version functions work on specific files and versions
version_bump () 
{ 
    : increment Major, minor, or patch version of provided version number
    : libs: fnusedlib
    : date: 2023-10-20;
    : date: 2024-06-19;
    : date: 2025-12-26: bump needs a starting version number
    debug ENTRY $# $@;
    local bump=$1;
    if [[ -n $2 ]]; then
	parts=(${(s:.:)2})
	set -- $parts
    else
        set -- 0 0 0;
    fi
    case $bump in 
        (M|[Mm]ajor)
            echo $(expr $1 + 1).0.0
        ;;
        (m|[Mm]inor)
            echo $1.$(expr $2 + 1).0
        ;;
        (p|[Pp]atch)
            echo $1.$2.$(expr $3 + 1)
        ;;
	(*)
	    echo "missing or invalid value: $bump" && return 1;
	;;
    esac
}
# 2025-12-16: claude.ai indir rewrite
# here a subshell is used to run the commands in the specified directory
indir () {
    : run commands IN the first DIRectory argument
    debug ENTRY $@
    [[ ! -d "$1" ]] && return 1
    local target_dir="$1"
    shift
    ( cd "$target_dir" && "$@" )
}
# 2025-12-24: find and list version linked files
version_files () {
    : find version linked files in local .ver/.bak directories
    for f in $(find .ver/ -type f); do
	: debug $(ls -i $f)
	local _inode=$(ls -i $f | cut -d' ' -f1)
	set -- $(find . -inum $_inode)
	print "version: $1 is linked to: $2"
    done
}

