# 2025-12-16: preliminary version library
# - based on SimpleVersion.md
# ``` example
# ln -f  a/b/.bak/file  .ver/{YYYY_MMDD_hhmmss}/a/b/file
# ```
#
# 2025-12-27: TODO: revisit dependency on 'backup_init' and ENV vars
version_init ()
{
    : insure a VERSION_DIRECTORY exists
    : uses: mkdir
    : date: 2025-12-16;
    if [ ! -d $VERSION_DIRECTORY ]; then
        mkdir $VERSION_DIRECTORY
    fi
}
# 2025-12-27: TODO: this entire function-based workflow needs review
# - specifically the filename independent notion of versions
# - my model is different from the way mm3 was thinking about versions
# 2025-12-27: version functions work on specific files and versions
# 2026-02-01: rename _bump to _next ? (think about it)
version_bump () 
{ 
    : increment Major, minor, or patch version of provided version number
    : uses: expr
    : libs: fnusedlib
    : date: 2023-10-20;
    : date: 2024-06-19;
    : date: 2025-12-26: bump needs a starting version number
    debug ENTRY $# $@;
    local bump=$1;
    if [[ -n $2 ]]; then
	parts=(${(s:.:)2})
	set -- $parts
    else
        set -- 0 0 0;
    fi
    case $bump in 
        (M|[Mm]ajor)
            echo $(expr $1 + 1).0.0
        ;;
        (m|[Mm]inor)
            echo $1.$(expr $2 + 1).0
        ;;
        (p|[Pp]atch)
            echo $1.$2.$(expr $3 + 1)
        ;;
	(*)
	    echo "missing or invalid value: $bump" && return 1;
	;;
    esac
}
# 2025-12-24: find and list version linked files
# 2026-01-23: support local and remote directories
version_files () {
    : find version linked files in VERSION_DIRECTORY/BACKUP_DIRECTORY directories
    : uses: cut, find, ls, sort
    : lib: zshutilib
    : date: 2026-01-23: support remote directories
    verdir=${VERSION_DIRECTORY:-.ver}
    : debug verdir: $verdir
    for f in $(find $verdir/ -type f)
    do
	: debug $(ls -i $f)
	local _inode=$(ls -i $f | cut -d' ' -f1) 
	set -- $(find $(dirname $verdir) -inum $_inode)
	print "$1 is linked to: $2"
    done | sort -t'/' -k3,3V -k4,4
}


version_latest () {
    : find latest version linked files in VERSION_DIRECTORY/BACKUP_DIRECTORY directories
    : uses: awk, cut, find, ls, sort
    : date: 2026-01-24: support local and remote directories
    local verdir=${VERSION_DIRECTORY:-.ver}
    for f in $(find $verdir/ -type f); do
	: debug $(ls -i $f)
	local _inode=$(ls -i $f | cut -d' ' -f1)
	set -- $(find $(dirname $verdir) -inum $_inode)
	print "$1 is linked to: $2"
    done | sort -t'/' -k3,3V -k4,4 | awk -F'/' '{latest[$4]=$0} END {for (lib in latest) print latest[lib]}' | sort
}
# 2026-01-04: claude sonnet-4 assisted analysis and debug update
# 2026-01-23: claude assist on parsing paths
version_new () {
    : create a new first or next version of a file
    : uses: find, ln, mkdir, sort, tail
    : libs: zshutilib, shutilib
    : date: 2026-01-23: support for remote directories
    debug ENTRY $# $@
    local backupdir=${BACKUP_DIRECTORY:-.bak}
    local versiondir=${VERSION_DIRECTORY:-.ver}
    debug "backupdir: $backupdir; versiondir: $versiondir"
    if [ $# -lt 1 ]
    then
	echo "Usage: version_new filename [M|m|p|semver]" && return 1
    elif [[ ! -f $backupdir/"$1" ]]
    then
	echo "error: $backupdir/$1 is not a file" && return 1
    fi
    local file=$1 
    if [[ -z $2 ]]
    then
	local bump=patch 
    elif [[ -n "$2" ]]
    then
	case "$2" in
	    (M) local bump=major  ;;
	    (m) local bump=minor  ;;
	    (p) local bump=patch  ;;
	    (*) if [[ $2 =~ ^[0-9]+(\.[0-9]+)*$ ]]
		then
		    local newversion=$2 
		else
		    error "invalid argument: %s\n" "$2"
		    return 1
		fi ;;
	esac
    fi
    echo "bump: $bump OR version: $newversion for $file"
    : pause
    if [[ -n $bump ]]
    then
	echo "bump $bump version for $file"
	: echo "determine previous version or assign 0.0.1"
	local highest=$(find $versiondir/ -name $file 2>/dev/null | sort -t'/' -k2 -V | tail -n 1) 
	: debug highest: $highest
	local currentversion=${${highest%/*}##*/}
	debug currentversion: $currentversion
	if [[ -n $currentversion ]]
	then
	    echo "bump $currentversion $bump value"
	    local newversion=$(version_bump $bump $currentversion) 
	else
	    case $bump in
		(major) local newversion=1.0.0  ;;
		(minor) local newversion=0.1.0  ;;
		(patch) local newversion=0.0.1  ;;
		(*) local newversion=0.0.1  ;;
	    esac
	fi
    fi
    echo "create version $newversion link file for $backupdir/$file"
    local newversiondir=${VERSION_DIRECTORY:-.ver}/$newversion 
    : debug newversiondir: $newversiondir
    [[ ! -d "$newversiondir" ]] && mkdir -pv $newversiondir
    : check if $backupdir/$file is already linked to the latest version
    local latest_ver=$(find $versiondir/ -name $file 2>/dev/null | sort -t'/' -k2 -V | tail -n 1)
    : debug latest_ver: $latest_ver
    : pause
    if [[ -n $latest_ver ]]
    then
	if [[ $backupdir/$file -ef $latest_ver ]]
	then
	    error "Cannot create version: $backupdir/$file unchanged since ${latest_ver#.ver/}"
	    return 1
	fi
    fi
    : create the version link
    ln -f $backupdir/$file $newversiondir/$file
}

# 2026-01-28: Gemini generated version pruning function
version_prune() {
    : remove older versions of \$1, default keep 5;
    : uses: find,  sort, tail, unlink;
    : lib: zshutilib
    debug ENTRY $# "$@"
    local filename="${1:-/dev/null}"
    local keep_count="${2:-5}"
    local verdir="${VERSION_DIRECTORY:-.ver}"
    report_notfile "$filename" && return 1
    
    find "$verdir" -name "$filename" | sort -Vr | tail -n +$((keep_count + 1)) | while read -r target_path; do
        if [[ -f "$target_path" ]]; then
            echo "Pruning version: $target_path"
            echo "unlink $target_path"
        fi
    done
}

version_status () {
	: show current VERSION_DIRECTORY information
	: lib: zshutilib
	: local directory version numbers from the most recent
	: date: 2026-01-24: support local and remote directories
	echo "List versions in $VERSION_DIRECTORY; most recent first"
	indir ${VERSION_DIRECTORY:-.ver} ls -t1
	echo "$VERSION_DIRECTORY version files:"
	version_files
}
