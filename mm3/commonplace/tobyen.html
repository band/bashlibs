<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2022-08-30 Tue 14:01 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>The Only Backup You'll Ever Need</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Marty McGowan" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<link rel="stylesheet" type="text/css" href="./style.css" />
<script type="text/javascript">
// @license magnet:?xt=urn:btih:e95b018ef3580986a04669f1b5879592219e2a7a&dn=public-domain.txt Public Domain
<!--/*--><![CDATA[/*><!--*/
     function CodeHighlightOn(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.add("code-highlighted");
         target.classList.add("code-highlighted");
       }
     }
     function CodeHighlightOff(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.remove("code-highlighted");
         target.classList.remove("code-highlighted");
       }
     }
    /*]]>*///-->
// @license-end
</script>
</head>
<body>
<div id="content">
<h1 class="title">The Only Backup You'll Ever Need</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orgbfa94a1">1. The Only Backup You'll Ever Need</a>
<ul>
<li><a href="#org16f7a76">1.1. backup Introduction</a></li>
<li><a href="#org828249f">1.2. functions&#xa0;&#xa0;&#xa0;<span class="tag"><span class="functions">functions</span>&#xa0;<span class="tangle">tangle</span></span></a></li>
<li><a href="#orgc5b2309">1.3. comment&#xa0;&#xa0;&#xa0;<span class="tag"><span class="recursion">recursion</span></span></a></li>
<li><a href="#org9c69c9e">1.4. Code reader's guide</a>
<ul>
<li><a href="#org7effc40">1.4.1. getting started&#xa0;&#xa0;&#xa0;<span class="tag"><span class="set">set</span>&#xa0;<span class="parameter">parameter</span></span></a></li>
<li><a href="#orgbfe91ab">1.4.2. down the chain&#xa0;&#xa0;&#xa0;<span class="tag"><span class="recursion">recursion</span></span></a></li>
<li><a href="#org7f0d4b0">1.4.3. and back up</a></li>
<li><a href="#org61f1867">1.4.4. general principals&#xa0;&#xa0;&#xa0;<span class="tag"><span class="quietly">quietly</span>&#xa0;<span class="ignore">ignore</span></span></a></li>
</ul>
</li>
<li><a href="#orgaa40fa4">1.5. Auxiliary Code&#xa0;&#xa0;&#xa0;<span class="tag"><span class="auxiliary">auxiliary</span></span></a></li>
<li><a href="#org1d45b6f">1.6. An application&#xa0;&#xa0;&#xa0;<span class="tag"><span class="REPAIR">REPAIR</span></span></a></li>
<li><a href="#orgfedbb5c">1.7. make the library, application</a></li>
</ul>
</li>
<li><a href="#orgd447326">2. reference&#xa0;&#xa0;&#xa0;<span class="tag"><span class="version">version</span></span></a></li>
</ul>
</div>
</div>
<div id="outline-container-orgbfa94a1" class="outline-2">
<h2 id="orgbfa94a1"><span class="section-number-2">1</span> The Only Backup You'll Ever Need</h2>
<div class="outline-text-2" id="text-1">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #a020f0;">function</span> <span style="color: #0000ff;">copyright_backup</span>
{ 
    comment <span style="color: #8b2252;">"Copyright (C) 2009-2022, JYATL - Just Yet Another Testing Lab"</span>;
    comment <span style="color: #8b2252;">"mailto: mcgowan (at) alum DOT mit DOT edu"</span>;
    : bkp: appleton.home./Users/applemcg/Dropbox/commonplace/software/backupfunction.org
}
<span style="color: #a020f0;">function</span> <span style="color: #0000ff;">backup_files</span>
{ 
    : returns names of the current backup files
    trace_call $<span style="color: #a0522d;">*</span>;
    indir .bak ls
}
<span style="color: #a020f0;">function</span> <span style="color: #0000ff;">backup_filesNot</span>
{ 
    : this should be collapsed into a more general command
    trace_call $<span style="color: #a0522d;">*</span>;
    find ${<span style="color: #a0522d;">*</span>:-.} -type f | grep -v <span style="color: #8b2252;">'\/\.'</span>
}
<span style="color: #a020f0;">function</span> <span style="color: #0000ff;">backup_init</span>
{ 
    <span style="color: #483d8b;">source</span> auxlib;
    copyright_backup
}
<span style="color: #a020f0;">function</span> <span style="color: #0000ff;">backup_lib</span>
{ 
    : is this really necessary?
    : since the only reason for eXecutable is to find the file
    : on your PATH
    trace_call $<span style="color: #a0522d;">*</span>;
    backup $<span style="color: #a0522d;">*</span>;
    chmod +x $<span style="color: #a0522d;">*</span>
}
<span style="color: #a020f0;">function</span> <span style="color: #0000ff;">backup_sync</span>
{ 
    : removing a file before backing up, pushes any backup down the chain
    : preserving the latest copy but it<span style="color: #8b2252;">'s no longer a "backup_file". </span>
<span style="color: #8b2252;">    : the "indir .. backup *" uses only the .BAK names in it'</span>s parent
    trace_call $<span style="color: #a0522d;">*</span>;
    ignore pushd ./.bak;
    <span style="color: #483d8b;">set</span> $(<span style="color: #ff00ff;">indir</span> .. ls * | <span style="color: #483d8b;">command</span> comm -13 - &lt;(ls *));
    backup $<span style="color: #a0522d;">*</span>;
    rm -f $<span style="color: #a0522d;">*</span>;
    indir .. backup *;
    <span style="color: #483d8b;">popd</span> 1&gt;&amp;2
}
<span style="color: #a020f0;">function</span> <span style="color: #0000ff;">backup_version</span>
{ 
    : create a version -- after sync for all current backup files
    trace_call $<span style="color: #a0522d;">*</span>;
    report_nondirectory .bak &amp;&amp; <span style="color: #a020f0;">return</span> 1;
    backup_sync;
    ln .bak/* $(<span style="color: #ff00ff;">needir</span> .ver/$(<span style="color: #ff00ff;">ymd_hms</span>))
}
<span style="color: #a020f0;">function</span> <span style="color: #0000ff;">backup_depth</span>
{ 
    find .bak | awk -F/ <span style="color: #8b2252;">'{ print NF }'</span> | sort | uniq -c | sort -n -k2
}
</pre>
</div>

<p>
here is how I learned to <a href="http://askubuntu.com/questions/299710/how-to-determine-if-a-string-is-a-substring-of-another-in-bash">repeatString</a>
</p>
</div>

<div id="outline-container-org16f7a76" class="outline-3">
<h3 id="org16f7a76"><span class="section-number-3">1.1</span> backup Introduction</h3>
<div class="outline-text-3" id="text-1-1">
<p>
This idea for a simple <b>backup</b> function, stems from my days at
Fidessa, where the question arose:
</p>

<p>
&gt; When using a script to back up a file, what if you successively copy
  the file down a chain of suffixes, say .001, .002, &#x2026;, but it's not
  long enough?
</p>

<p>
For example, you may have stopped at .004, when it was the
non-existent .005 you really needed.
</p>
<pre class="example" id="org7830f5e">
$ cp this.003 this.004
$ cp this.002 this.003
$ cp this.001 this.002
$ cp this.txt this.001
</pre>
<p>
Here are the <a href="../version/quickSimpleVersion.html">requirements for this backup</a>, and the related simple
version command.
</p>

<p>
To save unlimited backups, the file system offers a ready solution.
Rather than play with suffixes, just push a differing copy of the
current file down a directory stack.  Do this indefinitely until
you're satisfied.  In practice, I've seen this grow to
thirty-something entries before the need to clean-up arose.
</p>

<pre class="example" id="orgc877990">
$ ...
$ cp .bak/.bak/.bak/this.txt  .bak/.bak/.bak/.bak/this.txt 
$ cp .bak/.bak/this.txt       .bak/.bak/.bak/this.txt 
$ cp .bak/this.txt            .bak/.bak/this.txt 
$ cp this.txt                 .bak/this.txt 
</pre>

<p>
Notice the first line, "&#x2026;".  It suggests "one more if needed".  With
this backup, You'll never run out of backup directories.  Also, notice
that after copying this.txt to .bak, then .bak/this.txt is identical
to the current file.  That suggests an even simpler <i>version</i>-ing
system, which is the subject of  <a href="https://mcgowans.org/pubs/marty3/commonplace/version/quickSimpleVersion.html::*Introduction">this note.</a>
</p>

<p>
This paper is part of my <a href="../book.html">Commonplace Book</a>
</p>
</div>
</div>

<div id="outline-container-org828249f" class="outline-3">
<h3 id="org828249f"><span class="section-number-3">1.2</span> functions&#xa0;&#xa0;&#xa0;<span class="tag"><span class="functions">functions</span>&#xa0;<span class="tangle">tangle</span></span></h3>
<div class="outline-text-3" id="text-1-2">
<div class="org-src-container">
<pre class="src src-sh"><span id="coderef-backup" class="coderef-off"><span style="color: #a020f0;">function</span> <span style="color: #0000ff;">backup</span>                      <span style="color: #b22222;">#</span> (backup)</span>
{ 
    : backup file arguments
    <span style="color: #a020f0;">case</span> $<span style="color: #a0522d;">1</span><span style="color: #a020f0;"> in</span> 
<span id="coderef-gracefully" class="coderef-off">        <span style="color: #8b2252;">""</span>)                          <span style="color: #b22222;">#</span> (gracefully)</span>
            usage file ... recursively backup to .bak/.bak/...;
            <span style="color: #a020f0;">return</span>
        ;;
        *) 
            <span style="color: #483d8b;">local</span> <span style="color: #a0522d;">fun</span>=backup_$<span style="color: #a0522d;">1</span>
            is_function $<span style="color: #a0522d;">fun</span> &amp;&amp; {
                <span style="color: #483d8b;">shift</span>
                $<span style="color: #a0522d;">fun</span> $<span style="color: #a0522d;">*</span>
                <span style="color: #a020f0;">return</span>
            }
        ;;
    <span style="color: #a020f0;">esac</span>;
<span id="coderef-trace" class="coderef-off">    trace_call $<span style="color: #a0522d;">*</span>;                   <span style="color: #b22222;">#</span> (trace)</span>
    foreach backup_one <span style="color: #8b2252;">"$@"</span>
}
<span id="coderef-backup_here" class="coderef-off"><span style="color: #a020f0;">function</span> <span style="color: #0000ff;">backup_here</span>                 <span style="color: #b22222;">#</span> (backup_here)</span>
{
    : recursively backup one
    report_notcalledby backup_one &amp;&amp; <span style="color: #a020f0;">return</span> 1   
<span id="coderef-set" class="coderef-off">    <span style="color: #483d8b;">set</span> $<span style="color: #a0522d;">1</span> .bak ${<span style="color: #a0522d;">2</span>:-$<span style="color: #a0522d;">PWD</span>};          <span style="color: #b22222;">#</span> (set)</span>
<span id="coderef-mkdir" class="coderef-off">    [[ -d $<span style="color: #a0522d;">2</span> ]] || mkdir $<span style="color: #a0522d;">2</span>;         <span style="color: #b22222;">#</span> (mkdir)</span>
<span id="coderef-base directory" class="coderef-off">    [[ $<span style="color: #a0522d;">3</span> == $<span style="color: #a0522d;">PWD</span> ]] &amp;&amp; {            <span style="color: #b22222;">#</span> (base directory)</span>
<span id="coderef-cmp" class="coderef-off">        cmp $<span style="color: #a0522d;">1</span> $<span style="color: #a0522d;">2</span>/$<span style="color: #a0522d;">1</span> 2&gt; /dev/null 1&gt;&amp;2 &amp;&amp; <span style="color: #a020f0;">return</span> <span style="color: #b22222;">#</span> (cmp)</span>
    };
    [[ -f $<span style="color: #a0522d;">2</span>/$<span style="color: #a0522d;">1</span> ]] &amp;&amp; {            <span style="color: #b22222;"># </span><span style="color: #b22222;">more work to do, so</span>
        <span style="color: #483d8b;">cd</span> $<span style="color: #a0522d;">2</span>;                        <span style="color: #b22222;"># </span><span style="color: #b22222;">recursively descend</span>
        backup_here $<span style="color: #a0522d;">1</span> $<span style="color: #a0522d;">3</span>             <span style="color: #b22222;"># </span><span style="color: #b22222;">and backup this too</span>
    } || {                         <span style="color: #b22222;"># </span><span style="color: #b22222;">OR ...</span>
<span id="coderef-to the backup" class="coderef-off">        mv $<span style="color: #a0522d;">1</span> $<span style="color: #a0522d;">2</span>/$<span style="color: #a0522d;">1</span>;                  <span style="color: #b22222;">#</span> (to the backup)</span>
<span id="coderef-back to home base" class="coderef-off">        [[ $<span style="color: #a0522d;">3</span> == $<span style="color: #a0522d;">PWD</span> ]] &amp;&amp; {         <span style="color: #b22222;">#</span> (back to home base)</span>
<span id="coderef-current" class="coderef-off">            cp $<span style="color: #a0522d;">2</span>/$<span style="color: #a0522d;">1</span> $<span style="color: #a0522d;">1</span>;              <span style="color: #b22222;">#</span> (current)</span>
<span id="coderef-sametime" class="coderef-off">            timestamp $<span style="color: #a0522d;">2</span>/$<span style="color: #a0522d;">1</span> $<span style="color: #a0522d;">1</span>;       <span style="color: #b22222;">#</span> (sametime)</span>
            <span style="color: #a020f0;">return</span>
        };
<span id="coderef-recursively ascend" class="coderef-off">        <span style="color: #483d8b;">cd</span> ..;                        <span style="color: #b22222;">#</span> (recursively ascend)</span>
        backup_here $<span style="color: #a0522d;">1</span> $<span style="color: #a0522d;">3</span>
    }
}
<span id="coderef-backup_one" class="coderef-off"><span style="color: #a020f0;">function</span> <span style="color: #0000ff;">backup_one</span>                   <span style="color: #b22222;">#</span> (backup_one)</span>
{ 
    : allows non-local file names
    report_notfile $<span style="color: #a0522d;">1</span> &amp;&amp; <span style="color: #a020f0;">return</span> 1;
<span id="coderef-notcalledby" class="coderef-off">    report_notcalledby backup &amp;&amp; <span style="color: #a020f0;">return</span> 2  <span style="color: #b22222;">#</span> (notcalledby)</span>
<span id="coderef-ignore" class="coderef-off">    ignore pushd $(<span style="color: #ff00ff;">dirname</span> $<span style="color: #a0522d;">1</span>);       <span style="color: #b22222;">#</span> (ignore)</span>
<span id="coderef-invoked" class="coderef-off">    backup_here $(<span style="color: #ff00ff;">basename</span> $<span style="color: #a0522d;">1</span>);       <span style="color: #b22222;">#</span> (invoked)</span>
    ignore popd
}
</pre>
</div>
</div>
</div>
<div id="outline-container-orgc5b2309" class="outline-3">
<h3 id="orgc5b2309"><span class="section-number-3">1.3</span> comment&#xa0;&#xa0;&#xa0;<span class="tag"><span class="recursion">recursion</span></span></h3>
<div class="outline-text-3" id="text-1-3">
<p>
The three <b>backup</b> functions (backup, backup_here, and backup_one)
highlight an approach I'm now taking.  The function now named
<a href="#coderef-backup_here" class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-backup_here');" onmouseout="CodeHighlightOff(this, 'coderef-backup_here');">backup_here</a> was originally the first <i>backup</i> function I wrote.  As
a unit-test, I tested it on single files in the current directory.  I
tested the simple features before adding the ability to backup
multiple files and files not in the current directory.  So, as the
<i>backup</i> function evolved to add these separate features, the new
features are recognized by new names. While these names are accessible
to the user, they are rarely needed, and backing up a single file in
the same directory works to the same original interface.
</p>

<p>
The instances of <a href="#coderef-notcalledby" class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-notcalledby');" onmouseout="CodeHighlightOff(this, 'coderef-notcalledby');">notcalledby</a> effectively turn the function 
into a local function.   Comment the statement out to perform a
unit test of the function.
</p>
</div>
</div>

<div id="outline-container-org9c69c9e" class="outline-3">
<h3 id="org9c69c9e"><span class="section-number-3">1.4</span> Code reader's guide</h3>
<div class="outline-text-3" id="text-1-4">
</div>
<div id="outline-container-org7effc40" class="outline-4">
<h4 id="org7effc40"><span class="section-number-4">1.4.1</span> getting started&#xa0;&#xa0;&#xa0;<span class="tag"><span class="set">set</span>&#xa0;<span class="parameter">parameter</span></span></h4>
<div class="outline-text-4" id="text-1-4-1">
<p>
The first trick is on the first line, using a <a href="#coderef-set" class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-set');" onmouseout="CodeHighlightOff(this, 'coderef-set');">set</a> idiom, which in
this case, sets the shell's <i>positional parameters</i>.  Here, the first
parameter, $1 is unchanged and was assigned the name of the backup
file; the second is assigned the name of the backup directory, <code>.bak</code>,
while the third parameter is assigned either the <b>second</b> argument to
the function ($2), or defaults to the current directory ($PWD).
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">param</th>
<th scope="col" class="org-left">source</th>
<th scope="col" class="org-left">means</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">1</td>
<td class="org-left">$1</td>
<td class="org-left">backup file</td>
</tr>

<tr>
<td class="org-right">2</td>
<td class="org-left"><b>.bak</b></td>
<td class="org-left">backup directory</td>
</tr>

<tr>
<td class="org-right">3</td>
<td class="org-left">$2 or $PWD</td>
<td class="org-left">current directory</td>
</tr>
</tbody>
</table>

<p>
When <a href="#coderef-invoked" class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-invoked');" onmouseout="CodeHighlightOff(this, 'coderef-invoked');">invoked</a> the first time, the second argument is empty, so the
third positional parameter is set to the current working directory.
Now the assurance offered by <b><b>backup_one</b></b> insulating the <a href="#coderef-backup" class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-backup');" onmouseout="CodeHighlightOff(this, 'coderef-backup');">backup</a>
function from multiple file names is seen to be useful.  The third
parameter then holds the starting directory of the backup chain as a
means of branching; either are we starting down the chain, or are we
done, having returned from the last nested recursive call.
</p>

<p>
Then create (<a href="#coderef-mkdir" class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-mkdir');" onmouseout="CodeHighlightOff(this, 'coderef-mkdir');">mkdir</a>) a missing backup (<i>.bak</i>) directory.  
</p>
</div>
</div>

<div id="outline-container-orgbfe91ab" class="outline-4">
<h4 id="orgbfe91ab"><span class="section-number-4">1.4.2</span> down the chain&#xa0;&#xa0;&#xa0;<span class="tag"><span class="recursion">recursion</span></span></h4>
<div class="outline-text-4" id="text-1-4-2">
<p>
If we are just starting down the chain, the condition for <a href="#coderef-base directory" class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-base directory');" onmouseout="CodeHighlightOff(this, 'coderef-base directory');">base directory</a> is true.  Therefore, and only this first time, is it
necessary to compare the current file <code>$1</code> with it's most recent
backup <code>$2/$1</code>, which by the way, needn't exist.  If they are
identical the comparison <a href="#coderef-cmp" class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-cmp');" onmouseout="CodeHighlightOff(this, 'coderef-cmp');">cmp</a> succeeds and there is no further need
of comparing with other files. Return. There is nothing further to do.
</p>

<p>
Since there may not be a  <b><b>backup file</b></b> <code>$2/$1</code>, a decision is
necessary.  If there is a backup file, since it's now known to be
different, some precautions are necessary.  Since there is a backup
file, it too must be backed up. So, go to the backup directory and
recursively descend through any backup directories.
</p>

<p>
At some point there is no backup file.  Why?  We've descended to the
bottom of the chain of existing backups.
</p>

<p>
On the very first pass, you may have created the backup directory, the
<b>cmp</b> failed, the existence of a lower name is irrelevant (for the
moment).  So, now we are in a directory that has a proper backup file,
and the directory below does not, and therefore is ready for the file
to move <a href="#coderef-to the backup" class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-to the backup');" onmouseout="CodeHighlightOff(this, 'coderef-to the backup');">to the backup</a> directory.
</p>
</div>
</div>

<div id="outline-container-org7f0d4b0" class="outline-4">
<h4 id="org7f0d4b0"><span class="section-number-4">1.4.3</span> and back up</h4>
<div class="outline-text-4" id="text-1-4-3">
<p>
And worth thinking about for a moment.  We have just moved the backup
file to a lower directory that was open to receive it.  The directory
we are now in is now in a position to retrieve the file in its parent.
If we are <a href="#coderef-back to home base" class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-back to home base');" onmouseout="CodeHighlightOff(this, 'coderef-back to home base');">back to home base</a>, then we need to copy the <a href="#coderef-current" class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-current');" onmouseout="CodeHighlightOff(this, 'coderef-current');">current</a>
file we just moved into the top backup, now back to the base directory.
And, as a little flourish, set the time stamp on the file to the
<a href="#coderef-sametime" class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-sametime');" onmouseout="CodeHighlightOff(this, 'coderef-sametime');">sametime</a> as the just-moved file.  And return.  We're done.
</p>

<p>
If on the other hand, we have not returned up to the base directory,
then we <a href="#coderef-recursively ascend" class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-recursively ascend');" onmouseout="CodeHighlightOff(this, 'coderef-recursively ascend');">recursively ascend</a> the backup directory tree.  Remember on
the way up we are returning to a directory whose backup copy had just
been pulled down.  And we do this until we return to the base
directory.
</p>
</div>
</div>

<div id="outline-container-org61f1867" class="outline-4">
<h4 id="org61f1867"><span class="section-number-4">1.4.4</span> general principals&#xa0;&#xa0;&#xa0;<span class="tag"><span class="quietly">quietly</span>&#xa0;<span class="ignore">ignore</span></span></h4>
<div class="outline-text-4" id="text-1-4-4">
<p>
Before leaving, I'm employing some general principals that my shell 
practice has evolved:
</p>

<ul class="org-ul">
<li>do nothing gracefully</li>
</ul>

<p>
Here, the easy thing to do is give the user a help message.  For those
commands which will do nothing without an argument, take the opportunity
to show a <b>help</b> message.  In this case, remind the user the arguments
are files and may be many of them.
</p>

<p>
A grace I've learned to use: when there is a main function like <code>backup</code>
with a number of related sub-functions, allow a command-line user the option
of using a space, rather
</p>

<ul class="org-ul">
<li><a href="#coderef-trace" class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-trace');" onmouseout="CodeHighlightOff(this, 'coderef-trace');">trace</a> your execution.</li>
</ul>

<p>
While I like to trace every function, the exception here is the 
preponderant use of <b>backup</b> from the command line, or other script,
and the much rarer use of backup_here or backup_one in similar 
circumstances.   
</p>

<ul class="org-ul">
<li>use semantic commands, in this case <a href="#coderef-ignore" class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-ignore');" onmouseout="CodeHighlightOff(this, 'coderef-ignore');">ignore</a> the standard output</li>
</ul>

<p>
This is a big deal with me. Here is the code for <b>ignore</b> and, while we're at it
<b>quietly</b>:
</p>

<pre class="example" id="orgfb2b918">
function ignore
{ 
    $@ &gt; /dev/null
}
function quietly
{ 
    $@ 2&gt; /dev/null
}
</pre>
<p>
I would just as soon suffer any inefficiency at run-time to use a
semantic function over the syntactic means.  Syntax is for those who
need it to feel they understand the medium.  Semantics is for those
of use who'd like to read what they are doing.
</p>

<p>
E.g:
</p>

<pre class="example">
ignore   the (standard) output of this command.
quietly  do this command -- I don't need the error messages.
</pre>


<p>
Question:  do you think this means anything:
</p>

<pre class="example">
quietly ignore everything   
</pre>


<p>
is a vast improvement over
</p>

<pre class="example">
everything 2&gt;&amp;1 &gt;/dev/null         # or
everything 2&gt;/dev/null &gt;/dev/null   
</pre>
</div>
</div>
</div>

<div id="outline-container-orgaa40fa4" class="outline-3">
<h3 id="orgaa40fa4"><span class="section-number-3">1.5</span> Auxiliary Code&#xa0;&#xa0;&#xa0;<span class="tag"><span class="auxiliary">auxiliary</span></span></h3>
<div class="outline-text-3" id="text-1-5">
<p>
You have noted there are a number of commands in the backup code you
won't find in the *nix utilities on any system you've seen.  So,
here is the description (and code) for the <a href="auxlib.html">Auxiliary Library</a>
</p>
</div>
</div>

<div id="outline-container-org1d45b6f" class="outline-3">
<h3 id="org1d45b6f"><span class="section-number-3">1.6</span> An application&#xa0;&#xa0;&#xa0;<span class="tag"><span class="REPAIR">REPAIR</span></span></h3>
<div class="outline-text-3" id="text-1-6">
<p>
This challenge, noted in my <a href="swdiary.html">Software diary on Tuesday, 28th, 2015</a> is
to produce a fully-functioning application of the library functions.
There are three pieces: the functions above, the remainder of the
functions in the backup library, and any functions in the auxiliary
library.
</p>

<p>
Also the tooling it takes to move the pieces into place and write
their separate instances.
</p>
</div>
</div>
<div id="outline-container-orgfedbb5c" class="outline-3">
<h3 id="orgfedbb5c"><span class="section-number-3">1.7</span> make the library, application</h3>
<div class="outline-text-3" id="text-1-7">
<p>
As it now stands, here is the sequence to create both the local
library, and wrap it up as an application.  For the reader, I've
hidden the most of the backup functions in a library I'm not showing
in the on-line document, but are available to an editor of this
OrgMode source (and in the run-time code library and application).
</p>
</div>
</div>
</div>


<div id="outline-container-orgd447326" class="outline-2">
<h2 id="orgd447326"><span class="section-number-2">2</span> reference&#xa0;&#xa0;&#xa0;<span class="tag"><span class="version">version</span></span></h2>
<div class="outline-text-2" id="text-2">
<ol class="org-ol">
<li><a href="http://mcgowans.org/pubs/marty3/commonplace/software/backupfunction.html">http://mcgowans.org/pubs/marty3/commonplace/software/backupfunction.html</a> &#x2013; this paper, online</li>
<li>My <a href="../book.html">Commonplace Book</a></li>
<li><a href="../version/quickSimpleVersion.html">Companion, simple versioning system</a></li>
</ol>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: Marty McGowan</p>
<p class="date">Created: 2022-08-30 Tue 14:01</p>
<p class="validation"><a href="https://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
